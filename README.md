
## Как запустить Pipeline

0. Установить jenkins(я взял последнюю версию 2.346.1)

1. Сделать для jenkins юзера судо без пароля

    1.1 usermod -a -G sudo jenkins
    1.2 поправить /etc/sudoers

2. Настраиваем Global tools (http://JENKINS_URL:8080/configureTools/)

    2.1 Maven
    
        2.1.1 Название делаем "maven-3.8.6"

        2.1.2 Версию выбираем 3.8.6

    2.2 JDK

        2.2.1 Здесь нужно скачать дистрибутив и в ручную его настроить. Качал по ссылке https://github.com/hmsjy2017/get-jdk/releases/download/v8u231/jdk-8u231-linux-x64.tar.gz. Это не совсем официальный дистрибьютер, но в целом выглядит безобидно.

        2.2.2 Распаковать архив по пути /usr/lib/jvm/jdk1.8.0_231. Его же и ввести в поле JAVA_HOME(jenkins).

        2.2.3 Название делаем "jdk-8"

3. Устанавливаем плагин для jenkins под названием Git plugin и Pipeline, если установка jenkins была без дефолтных модулей.

4. Создаем новый итем с названием hadloop-ci и типом Pipeline

    4.1 В Pipeline -> Definition выбираем Pipeline script from SCM

    4.2 SCM -> Git 

    4.3 Repositories -> Repositories URL делаем https://github.com/ninjawtf/hadoop.git. Моя репозитория с форкнутым Hadoop и файлом Jenkinsfile

    4.4 Branches to build -> Branch Specifier делаем */branch-3.1.1

5. На агенте, где будет выполнять пайплайн нужно создать папочку /opt/hadloop и навесить на нее права для jenkins(sudo mkdir /opt/hadloop  sudo chown jenkins:jenkins /opt/hadloop)

6. Сборка происходила на amd64 x64 ubuntu 20.04

7. Поправить PATH (export PATH="$PATH:/opt/hadoop/bin") на сервере, где будет запускаться hadoop

8. Под юзером jenkins на агенте(сервере) выполнить(для подключения к себе же по ключу):
```   
   ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa
   cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
   chmod 0600 ~/.ssh/authorized_keys
```


В целом это минимальный набор для корректного запуска пайплайна. 

## Пайплайн делает:
1. Предустановку окружения

2. Билд дистрибутива

3. Псевдодеплой дистрибутива

4. Настройку Hadoop





## Дополнение. Улучшения пайплайна.
1. Проблема: Мне не очень нравится такая предустановка, с помощью apt-get и сборка protobuf. Отнимает лишнее время.
   
   Решение: 

     1.1 Использовать готовый Docker образ со всем необходимым(в целом по дефолту такое предлагается в официальной документации).

     1.2 Установить на агент заранее все нужные библиотеки и собранный protobuf.
2. Проблема: В целом 25 минут сборки для такого проекта - норм. Но хотелось бы поменьше.
   
   Решение:
   
     2.1 В целом можно продумать архитектуру пайплайна, при котором собирался бы только какой-нибудь один модуль, а не все сразу. При этом другие собранные модули должны лежать где-то рядом(возможно из кэша подтягиваться) для работы зависимостей.

3. Проблема: Деплой очень сильно упрощен и захардкожен (3.1.*). Нет разноса на сервера, все деплоится локально.
   
   Решение:
     
     3.1 В целом это простенький пример деплоя. Первое что бы я добавил - пуш собранного дистрибутива куда-нить в хранилище(например Nexus).

     3.2 Убрал бы хардкод и брал собранную версию откуда-нибудь динамически(как пример какой-нибудь счетчик, или из переменной).

     3.3 Разделил бы деплой и билд, чтобы можно было куда-то деплоить без триггера сборки.
4. Проблема: Захардкожена ветка для сборки (3.1.1).

   Решение: Нужно сделать в гитлабе хук на пуш, если пушится коммит, то мы начинаем сборку из этой ветки.

Проблемы, которые встретил:

1. Подбил пакеты, которые необходимы для сборки.

2. Проблема из разряда - сам дурак :) поставил JDK х32 разрядности на х64 убунту. Промаялся с пакетами и линками, когда копнул глубже и понял почему ничего не хочет собираться - пробил себе фейспалмом лицо и поставил x64 jdk.